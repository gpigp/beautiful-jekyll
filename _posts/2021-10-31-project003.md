---
layout: post
title: Project003
subtitle: SNP and INDEL calling
cover-img: /assets/post3-img/indel.png
thumbnail-img: https://gpigp.github.io/taehyun/assets/post3-img/marmoset.jpg
tags: [SNP, INDEL, Marmoset, Stanford, GATK4, BWA]

published: true
---

Call SNPs and INDELs
============================

*❕ docker 환경에서 진행되었습니다.*

<h2> 1. Reference & Paired-end whole-genome sequencing data </h2>
<br>
<h6> 2020년 Marmoset Reference </h6>
   
```
wget https://hgdownload.soe.ucsc.edu/goldenPath/calJac4/bigZips/calJac4.fa.gz
gzip -d calJac4.fa.gz
```    
<br>
<h6> SRR7050660(read2) & SRR7050661(read1)</h6>
   
```
wget https://sra-downloadb.be-md.ncbi.nlm.nih.gov/sos2/sra-pub-run-13/SRR7050660/SRR7050660.1
wget https://sra-downloadb.be-md.ncbi.nlm.nih.gov/sos2/sra-pub-run-13/SRR7050661/SRR7050661.1
```   
<br>
<h2> 2. SRA Toolkit 다운 </h2>
<br>
SRR7050660.1, SRR7050661.1 각각은 분리시킬수 있는데, SRA Toolkit이 필요합니다.   
[👈](https://github.com/ncbi/sra-tools/wiki/02.-Installing-SRA-Toolkit) <u>참조</u>
<br>
<h6> SRA Toolkit 파일 다운 </h6>
```
wget --output-document sratoolkit.tar.gz http://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/current/sratoolkit.current-ubuntu64.tar.gz
tar -vxzf sratoolkit.tar.gz
```    
<br>
<h6> 환경변수 설정 </h6>
```
export PATH=$PATH:$PWD/sratoolkit.2.11.2-ubuntu64/bin
which fastq-dump
```
*❕ which 이후 아무것도 안뜬다면 설치가 안된 것.*
<br>
<span style="color: #2D3748; background-color: #fff5b1">2022.04.26.fixed</span>
<br>
   

   #### #fastq-dump -I --split-files 파일이름    
   파일이름_1.fastq, 파일이름_2.fastq로 분리된다.

   ```
   fastq-dump -I --split-files SRR7050660
   ```
   <br/>
   <br/>

3. 2개의 fastq를 reference에 매핑 시키기

    * bwa 설치    
    매핑 시키기 위해서는 bwa를 설치해야 한다.    
        https://angus.readthedocs.io/en/2013/bwa-tutorial.html 이 링크에서 Installing and running bwa를 참고했다.    
        
        - 다운받을 경로    
        ```
        cd /mnt
        ```    
        
        - bwa 파일 다운로드
        ```
        curl -L -o bwa-0.7.5.tar.bz2 http://sourceforge.net/projects/bio-bwa/files/bwa-0.7.5a.tar.bz2/download
        ```    
        
        - tar 파일 압축 해제
        ```
        tar xvfj bwa-0.7.5a.tar.bz2
        ```    
        
        - 위치 이동
        ```
        cd bwa-0.7.5a
        ```    
        
        - make를 하면 자동 설치가 된다
        ```
        make
        ```    
        
        - 환경변수 설정
        ```
        cp bwa /usr/local/bin
        ```
        
        - fasta 및 fastq가 있는 파일로 이동
        ```
        cd home/Lab_Project_003
        ```    
            
    * reference genome 인덱스 만들기    
        #### #bwa index 파일이름.fa
        ```
        bwa index carJac4.fa
        ```    
    
    * 실제 매핑하기    
        .fa와 .fastq를 실제 매핑하는 단계이다.    
        output으로 .sai 파일이 생성된다.    
        #### #bwa aln (레퍼런스)파일이름.fa 파일이름_1.fastq > 파일이름_1.sai
        위의 명령어를 사용하면 cpu 코어 하나만 사용하게 된다.
        #### #bwa aln -t 사용할코어개수 -q 15 (레퍼런스)파일이름.fa 파일이름_1.fastq > 파일이름_1.sai    
        위의 명령어를 사용하면 지정한 코어 개수로 사용하게 되므로 속도가 빨라진다.(q -15는 아직 무슨 의미인지 모르나 사용함)
        ```
        bwa aln -t 32 -q 15 calJac4.fa SRR7050660_1.fastq > SRR7050660_1.sai    
        bwa aln -t 32 -q 15 calJac4.fa SRR7050660_2.fastq > SRR7050660_2.sai
        ```    
   
    * SAM 파일    
        sai 파일은 유용하지않다.    
        따라서 SAM 파일로 변경해준다
        #### #bwa sampe (레퍼런스)파일이름.fa 파일이름_1.sai 파일이름_2.sai 파일이름_1.fastq 파일이름_2.fastq > 파일이름_bwa.sam
        ```
        bwa sampe calJac4.fa SRR7050660_1.sai SRR7050660_2.sai SRR7050660_1.fastq SRR7050660_2.fastq > SRR7050660_bwa.sam
        ```    
        <br/>
        <br/>
        
4. sam 파일을 bam 파일로 변경하기

    * Samtool 설치
    sam 파일을 bam 파일로 만들려면 samtool이 필요하다.
        ```
        cd /root
        curl -O -L http://sourceforge.net/projects/samtools/files/samtools/0.1.19/samtools-0.1.19.tar.bz2
        tar xvfj samtools-0.1.19.tar.bz2
        cd samtools-0.1.19
        make
        ```    
        
        <span style="color:red">※ 오류 발생</span>
        ``` c
        bam_tview_curses.c:41:10: fatal error: curses.h: No such file or directory
        #include <curses.h>
                 ^~~~~~~~~~
        compilation terminated.
        Makefile:129: recipe for target 'bam_tview_curses.o' failed
        make: *** [bam_tview_curses.o] Error 1
        ```    
        
        - make시 위와 같은 오류가 뜬다면 libncureses5-dev를 설치해야 합니다.
        ```
        apt update && \
        apt install -y \
        libncurses5-dev \
        libncursesw5-dev
        ```    
        
        - 이후 아래의 과정은 동일합니다.
        ```
        cp samtools /usr/local/bin
        cd misc/
        cp *.pl maq2sam-long maq2sam-short md5fa md5sum-lite wgsim /usr/local/bin/
        ```
        
        - fasta, fastq, sam 파일이 있는 곳으로 이동
        ```
        cd /home/Lab_Project002
        ```
    * samtool 사용하여 bam파일 만들고 분류하기
    
        - reference genome의 인덱스 생성
        ```
        samtools faidx calJac4.fa
        ```
        
        - sam 파일을 bam 파일로 만들기
        ```
        samtools import calJav4.fa.fai SRR7050660_bwa.sam SRR7050660_bwa.bam
        ```
        
        - bam 파일 분류하기    
        -@ 32를 사용하여 multithreading
        ```
        samtools sort -@ 32 SRR7050660_bwa.bam SRR7050660_bwa.sorted
        ```
        
        - 분류된 bam 파일의 인덱스 생성
        ```
        samtools index RAL357_bwa.sorted.bam
        ```

